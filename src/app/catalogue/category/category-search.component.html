<div *ngIf="isLogistics">
    <p class="pb-3 nimble-title">Publish Logistics Product</p>
</div>
<div *ngIf="!isLogistics">
    <p class="pb-3 nimble-title">Publish Product</p>
</div>
<p>All published products must belong to at least one category, which will describe the product and help customers find your offering.</p>
<div class="form-group row d-flex">
    <div class="col-12 inline">
        <form #categorySearch="ngForm" (ngSubmit)="onSearchCategory()" novalidate>
        <!-- TODO: All Categories Search Goes Here-->
            <div class="input-group">
                <div ngbDropdown class="d-inline-block input-group-prepend">
                    <button class="btn btn-outline-dark" type="button" id="allCategories" ngbDropdownToggle>
                        All Categories
                    </button>
                    <!-- TODO: Requires a service change -->
                    <div ngbDropdownMenu aria-labelledby="allCategories">
                        <a class="dropdown-item">All Categories</a>
                    </div>
                </div>
                <!-- End TODO: All Categories Search -->
                <input type="text" class="form-control" name="inputCtrl" [(ngModel)]="categoryKeyword" placeholder="Search Category..."/>
                <div class="input-group-append">
                    <button type="submit" class="btn btn-primary" [disabled]="!categorySearch.form.valid">
                        <i class="fa fa-search"></i> Search Categories
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="row mt-4 d-flex">
    <div class="col-7 pr-0 pb-0">

        <!-- Search Result List -->
        <div *ngIf="!treeView" class="border" style="height:55vh; overflow-x: hidden; overflow-y: scroll;">
            <table class="table table-hover mb-0">
                <thead class="thead-light fixed">
                    <th scope="col" style="color: #000;">Classification</th>
                    <th scope="col" style="color: #000;">Name</th>
                    <th scope="col" colspan="2" class="p-0 text-right"><button class="btn btn-secondary mb-1" (click)="toggleTreeView()">Browse</button></th>
                </thead>
                <tbody>
                    <tr *ngIf="getCategoriesStatus.isDisplayed()">
                        <call-status [callStatus]="getCategoriesStatus"></call-status>
                    </tr>
                    <tr *ngIf="!getCategoriesStatus.isDisplayed() && (!categories || categories.length == 0)">
                        <td colspan="3">No results found.</td>
                    </tr>
                    <ng-container *ngIf="!getCategoriesStatus.isDisplayed() && categories">
                        <tr *ngFor="let category of categories"
                            (click)="getCategoryDetails(category,false)"
                            [ngClass]="{'table-secondary': selectedCategory && category.code == selectedCategory.code}">
                            <td class="py-2 px-3 font-weight-light">{{category.taxonomyId}}</td>
                            <td class="py-2 px-3">{{category.preferredName}}</td>
                            <td></td>
                            <td class="py-2 px-3">
                                <span class="fa fa-fw mr-1 icon-secondary fa-sitemap" aria-hidden="true" (click)="getCategoryTree(category)"></span>
                            </td>
                        </tr>
                    </ng-container>
                </tbody>
            </table>
        </div>

        <!-- Tree view activated -->
        <div *ngIf="treeView" class="border" style="height:55vh; overflow-x: hidden; overflow-y: scroll;">
            <div class="fixed" style="background-color: #e9ecef;">
                <div class="row border">
                    <div class="pr-0 col-3">
                        <div class="thead-light-equivalent">
                            <p *ngIf="selectedTab == 'TREE'" class="mb-0" style="padding: 0.50rem;text-align: center">Categories For</p>
                            <p *ngIf="selectedTab != 'TREE'" class="mb-0" style="padding: 0.50rem;text-align: center">Categories</p>
                        </div>
                    </div>
                    <div *ngIf="selectedTab == 'TREE'" class="col-5 taxonomyDiv" >
                        <div ngbDropdown class="thead-light-equivalent taxonomy">
                            <button class="col-12 btn btn-outline-dark" type="button" id="taxonomy" ngbDropdownToggle>
                                {{taxonomyId}}
                            </button>
                            <div ngbDropdownMenu aria-labelledby="taxonomy">
                                <a *ngFor="let taxonomyID of taxonomyIDs" class="dropdown-item" (click)="changeTaxonomyId(taxonomyID)">{{taxonomyID}}</a>
                            </div>
                        </div>
                    </div>
                    <div class="pl-0" [ngClass]="selectedTab == 'TREE' ? 'col-4' :'col-9'">
                        <div class="thead-light-equivalent">
                            <button *ngIf="categories" class="btn btn-secondary float-right my-1 mr-1" (click)="toggleTreeView()">Back to Search Results</button>
                        </div>
                    </div>
                </div>
            </div>
            <div>

                <div class="d-flex flex-column" style="height: 100px">

                  <!-- Tabs -->
                  <div>
                    <ul class="nav nav-tabs pt-2 pl-1 pr-1">
                      <li *ngIf="!isLogistics" class="nav-item">
                        <a href id="TREE" class="nav-link" [ngClass]="{ active: selectedTab === 'TREE'}" (click)="onSelectTab($event)">
                          All (Product)
                        </a>
                      </li>
                      <li *ngIf="isLogistics" class="nav-item">
                        <a href id="TREE" class="nav-link" [ngClass]="{ active: selectedTab === 'TREE'}" (click)="onSelectTab($event)">
                          All (Logistics)
                        </a>
                      </li>
                      <li class="nav-item">
                        <a href id="FAVORITE" class="nav-link" [ngClass]="{ active: selectedTab === 'FAVORITE'}" (click)="onSelectTab($event)">
                          Favorite
                        </a>
                      </li>
                      <li class="nav-item">
                        <a href id="RECENT" class="nav-link" [ngClass]="{ active: selectedTab === 'RECENT'}" (click)="onSelectTab($event)">
                          Recently Used
                        </a>
                      </li>
                    </ul>
                  </div>

                    <!-- Favorite Categories -->
                    <div *ngIf="selectedTab === 'FAVORITE'">
                      <call-status [callStatus]="favoriteCategoriesStatus"></call-status>
                      <div *ngIf="prefCats.length > 0 && !favoriteCategoriesStatus.isDisplayed()">
                        <!--<h4 class="p-2">Favorite Categories</h4>-->
                        <div *ngFor="let prefCat of prefCats" class="py-2 hover-row d-flex border-bottom" style="padding-left:0.75rem"
                              [ngClass]="{'selected-row': isAdSelected(prefCat)}" (click)="showAdDetails(prefCat);">
                            {{prefCat.split("::")[2]}}
                        </div>
                      </div>
                      <div *ngIf="prefCats.length == 0 && !favoriteCategoriesStatus.isDisplayed()">
                        <!--<h4 class="p-2">Favorite Categories</h4>-->
                        <div class="py-2 d-flex" style="padding-left:0.75rem">No favorite categories</div>
                      </div>
                    </div>

                    <!-- Recent Categories -->
                    <div *ngIf="selectedTab === 'RECENT'">
                      <call-status [callStatus]="recentCategoriesStatus"></call-status>
                      <div *ngIf="recCats.length > 0 && !recentCategoriesStatus.isDisplayed()">
                        <!--<h4 class="p-2">Recently Used Categories</h4>-->
                        <div *ngFor="let recCat of recCats" class="py-2 hover-row d-flex border-bottom" style="padding-left:0.75rem"
                              [ngClass]="{'selected-row': isAdSelected(recCat)}" (click)="showAdDetails(recCat);">
                            {{recCat.split("::")[2]}}
                        </div>
                      </div>
                      <div *ngIf="recCats.length == 0 && !recentCategoriesStatus.isDisplayed()">
                        <!--<h4 class="p-2">Recently Used Categories</h4>-->
                        <div class="py-2 d-flex" style="padding-left:0.75rem">No recently used categories</div>
                      </div>
                    </div>

                    <!-- Tree view (all categories) -->
                    <div *ngIf="selectedTab === 'TREE'">

                      <call-status [callStatus]="getCategoriesStatus"></call-status>

                      <!-- Logistic Service Categories -->
                      <div *ngIf="isLogistics">
                          <!--<h4 class="p-2">Logistics Categories</h4>-->
                          <ng-container *ngIf="eClassLogisticsCategory && !getCategoriesStatus.isDisplayed()">
                              <category-tree [category]="eClassLogisticsCategory" [border]="false" [parentCategories]="parentCategories" [numberOfSteps]="parentCategories ? parentCategories.parents.length-1 : 0"
                                  (detailsEvent)="getCategoryDetails($event,false)" [selectedCategory]="selectedCategory"
                                  [selectedCategories]="selectedCategories"></category-tree>
                          </ng-container>
                          <h5 *ngIf="!eClassLogisticsCategory" class="noLogisticCategory">No available category</h5>
                      </div>

                      <!-- Product Categories -->
                      <div *ngIf="!isLogistics">
                          <!--<h4 class="p-2">Product Categories</h4>-->
                          <ng-container *ngIf="rootCategories && !getCategoriesStatus.isDisplayed()">
                              <div *ngFor="let rootCategory of rootCategories">
                                  <category-tree [category]="rootCategory" [parentCategories]="parentCategories" [numberOfSteps]="parentCategories ? parentCategories.parents.length-1 : 0"
                                      (detailsEvent)="getCategoryDetails($event,false)" [selectedCategory]="selectedCategory"
                                      [selectedCategories]="selectedCategories"></category-tree>
                              </div>
                          </ng-container>
                      </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Details Panel -->
    <div class="col-5 pl-0">
        <div class="border" [ngClass]="{'disabled-section': !selectedCategoryWithDetails && (callback || !submitted || error_detc)}" style="height:55vh; overflow-x: hidden; overflow-y: scroll;">

            <!-- Loading/Error call status -->
            <call-status [callStatus]="getCategoryDetailsStatus"></call-status>

            <!-- Title + buttons -->
            <div *ngIf="selectedCategoryWithDetails" class="d-flex flex-row fixed p-2" [ngClass]="{'fixed-header': selectedCategoryWithDetails}">
                <h4 class="font-weight-bold" *ngIf="!selectedCategoryWithDetails">Details</h4>
                <h4 class="font-weight-bold mr-auto" *ngIf="selectedCategoryWithDetails">Details for {{selectedCategoryWithDetails["preferredName"]}}</h4>
                <div *ngIf="selectedCategoryWithDetails">
                    <button *ngIf="findCategoryInArray(selectedCategories, selectedCategoryWithDetails) === -1"
                            class="btn btn-primary float-right" (click)="addCategoryToSelected(selectedCategoryWithDetails)">
                        Select Category
                    </button>
                    <button *ngIf="findCategoryInArray(selectedCategories, selectedCategoryWithDetails) > -1"
                            class="btn btn-danger float-right" (click)="removeCategoryFromSelected(selectedCategoryWithDetails)">
                        Unselect Category
                    </button>
                    <br/>
                    <button *ngIf="!findPrefCat(selectedCategoryWithDetails)" [disabled]="addFavoriteCategoryStatus.isLoading()"
                            class="btn btn-primary mt-1 float-right" (click)="addCategoryToFavorites(selectedCategoryWithDetails)">
                        Add To Favorite
                    </button>
                    <button *ngIf="findPrefCat(selectedCategoryWithDetails)" [disabled]="addFavoriteCategoryStatus.isLoading()"
                            class="btn btn-danger mt-1 float-right" (click)="removeCategoryFromFavorites(selectedCategoryWithDetails)">
                        Remove From Favorite
                    </button>
                    <div class="float-right">
                        <call-status [callStatus]="addFavoriteCategoryStatus"></call-status>
                    </div>
                </div>
            </div>

            <!-- No Category Details -->
            <p *ngIf="!selectedCategoryWithDetails" [hidden]="!(callback || !submitted || error_detc)" class="align-self-center p-2 mt-4">Click on a category to see its details.</p>

            <!-- Details -->
            <div *ngIf="selectedCategoryWithDetails" class="p-2 mt-2">
                <div *ngFor="let propName of propertyNames" class="my-1">
                    <text-input *ngIf="selectedCategoryWithDetails[propName]" [visible]="selectedCategoryWithDetails[propName]" presentationMode="view" [label]="propName" labelClass="col-12 text-capitalize" labelMainClass="mb-0" valueClass="col-12" valueTextClass="mb-1 pl-3" [text]="getCategoryProperty(propName)"></text-input>
                </div>
                <div class="row">
                    <div class="col-12 mb-0" *ngIf="selectedCategoryWithDetails.properties.length > 0">
                        <label>
                            <strong>Properties: </strong>
                        </label>
                    </div>
                </div>
                <div *ngFor="let prop of selectedCategoryWithDetails.properties;let i = index;let l = last">
                    <div class="row">
                        <div class="col-8">
                            <label>
                                <p class="text-capitalize pl-3 mb-1">
                                    {{prop.preferredName}}
                                    <span *ngIf="prop.definition" class="label label-default" title="{{prop.definition}}">
                                        &#9432;
                                    </span>
                                </p>
                            </label>
                        </div>
                        <div class="col-4">
                            <label>
                                <p class="mb-1 font-weight-light">
                                    {{getPropertyType(prop)}}
                                </p>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<hr>

<!-- Actions: no permission -->
<div *ngIf="!this.appComponent.checkRoles('catalogue')" class="form-group row">
    <div class="col-12 d-flex align-items-center">
        <p class="mt-1 mb-0 mr-3">You do not have permission to publish any products to your company catalogue.</p>
    </div>
</div>

<!-- Selected Categories + Action -->
<div *ngIf="this.appComponent.checkRoles('catalogue')" class="form-group row">
    <div class="col-9 d-flex align-items-center">
        <p class="mt-1 mb-0 mr-3 flex-shrink-0">Selected Categories: </p>
        <p class="mt-1 mb-0 mr-3 flex-shrink-0" *ngIf="categoryService.selectedCategories.length === 0">None. Please add a category above to proceed.</p>
        <div class="w-100 h-100 align-self-start">
            <div class="d-flex flex-wrap">
                <div *ngFor="let selectedCategory of categoryService.selectedCategories"
                class="bordered d-flex align-items-center mx-1 my-1" title="{{selectedCategory.taxonomyId}}">
                    <small class="p-0">{{selectedCategory.preferredName}}</small>
                    <i class="fa fa-times-circle pl-1 text-red" placement="right" (click)="removeCategoryFromSelected(selectedCategory)"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-3 align-self-center">
        <button class="btn btn-primary w-100 inline" [disabled]="categoryService.selectedCategories.length === 0 || navigateToPublishStatus.isLoading()"
                (click)="navigateToPublishingPage()">
            <span *ngIf="!navigateToPublishStatus.isLoading()">
                Continue With Selected Categories
            </span>
            <img *ngIf="navigateToPublishStatus.isLoading()" class="space-before" src="assets/form_loader.gif"/>
        </button>
        <call-status *ngIf="navigateToPublishStatus.isError()" [callStatus]="navigateToPublishStatus"></call-status>
    </div>
</div>
