<!-- Title -->
<div class="row">
    <div class="col-12">
        <p class="nimble-title" i18n>Company Settings</p>
    </div>
</div>

<!-- Tabs -->
<div>
	<ul class="nav nav-tabs">
		<li class="nav-item">
			<a href id="COMPANY_DATA" class="nav-link" [ngClass]="{ active: selectedTab === 'COMPANY_DATA'}" (click)="onSelectTab($event)">
				Company Data
			</a>
		</li>
		<li class="nav-item">
			<a href id="NEGOTIATION_SETTINGS" class="nav-link" [ngClass]="{ active: selectedTab === 'NEGOTIATION_SETTINGS'}" (click)="onSelectTab($event)">
				Negotiation Settings
			</a>
		</li>
	</ul>
</div>

<!-- Company Data -->
<ng-container *ngIf="selectedTab === 'COMPANY_DATA'">
	<!-- Call Status -->
	<call-status [callStatus]="initCallStatus" [large]="true"></call-status>

	<!-- Form -->
	<form [hidden]="initCallStatus.isDisplayed()" [formGroup]="settingsForm" novalidate>
		<!-- Request change button -->
		<button class="btn btn-primary mt-3 mb-3" type="button" (click)="changeData(changeModal)">
			<span>Request Company Data Change</span>
		</button>

		<!-- Legal Name -->
		<div class="form-group row">
			<label class="col-2 col-form-label">Legal Name</label>
			<div class="col-10">
				<input type="text" class="form-control" [formControl]="settingsForm.controls['name']" readonly>
			</div>
		</div>

		<!-- VAT Number -->
		<div class="form-group row">
			<label class="col-2 col-form-label">VAT Number</label>
			<div class="col-10">
				<input type="text" class="form-control" [formControl]="settingsForm.controls['vatNumber']" readonly>
			</div>
		</div>

		<!-- Verification Info -->
		<div class="form-group row">
			<label class="col-2 col-form-label">
				<span>Verification Info</span>
				<span class="tooltip-icon" (click)="showVerificationTT(tooltip)"><i class="fa fa-question-circle"></i></span>
			</label>
			<div class="col-10">
				<input type="text" class="form-control" [formControl]="settingsForm.controls['verificationInformation']" readonly>
			</div>
		</div>

		<!-- Website -->
		<div class="form-group row">
			<label class="col-2 col-form-label">Website</label>
			<div class="col-10">
				<input type="text" class="form-control" [formControl]="settingsForm.controls['website']" readonly>
			</div>
		</div>
		<address-form [group]="settingsForm.controls.address"></address-form>

		<h3 class="space-after">Delivery Terms</h3>

		<!-- Add new address -->
		<div class="form-group row">
			<div class="col-2 col-form-label">
				<button class="btn btn-primary w-100" [ngClass]="{ 'btn-danger': setAddress === true}" type="button" (click)="addDeliveryTerms()">
					<span *ngIf="!setAddress">Add New Address</span>
					<span *ngIf="setAddress">Cancel</span>
				</button>
			</div>
		</div>

		<div *ngIf="setAddress">
				<delivery-terms-form [group]="newAddress.controls[0]"></delivery-terms-form>
		</div>

		<!-- Deliver to company address
		<div class="form-group row">
			<span class="col-12 col-form-label">
				<input type="checkbox" [(ngModel)]="aM" [ngModelOptions]="{standalone:true}" (change)="settingsForm.controls['name'].markAsDirty();changeFlag();">
				<span class="border-0 form-control d-inline">Deliver to company address</span>
			</span>
		</div>
		<delivery-terms-form [group]="settingsForm.controls.deliveryTerms.controls[0]"></delivery-terms-form>
		-->
		
		<!--
		<h3 class="space-after">Payment Terms</h3>
		<payment-means-form [group]="settingsForm.controls.paymentMeans.controls[0]"></payment-means-form>
		-->

		<!-- Ppap -->
		<h3 class="space-after">PPAP</h3>
		<div class="form-group row">
			<label class="col-2 col-form-label">Compatibility Level</label>
			<div class="col-10">
				<select class="form-control" [formControl]="settingsForm.controls['ppapCompatibilityLevel']">
					<option value="0">-</option>
					<option value="1">Level 1</option>
					<option value="2">Level 2</option>
					<option value="3">Level 3</option>
					<option value="4">Level 4</option>
					<option value="5">Level 5</option>
				</select>
			</div>
		</div>

		<!-- Certificates -->
		<div class="form-group row">
			<div class="col-12">
				<button class="btn btn-primary" type="button" (click)="addCertificate(addCertModal)">
					<span>Add Certificate</span>
				</button>
				<table class="table table-striped table-bordered mb-0 mt-2">
					<tr><th>Certificate Type</th><th>Certificate Name</th><th class="col-3">Actions</th></tr>
					<tr *ngIf="certificates.length==0"><td colspan="3">No data</td></tr>
					<tr *ngFor="let certificate of certificates; let i = index">
						<td>{{certificate.type}}</td>
						<td>{{certificate.name}}</td>
						<td>
							<button class="btn btn-primary btn-sm" [disabled]="certificatesCallStatus[i].isLoading()" (click)="downloadCertificate(certificate.id)">Download</button>
							<button class="btn btn-danger btn-sm ml-1" [disabled]="certificatesCallStatus[i].isLoading()" (click)="removeCertificate(certificate.id, i)">Delete</button>
							<call-status [callStatus]="certificatesCallStatus[i]"></call-status>
						</td>
					</tr>
				</table>
			</div>
		</div>

		<!-- Favorite Categories -->
		<h3 class="space-after">Favorite Categories</h3>
		<div class="form-group row">
			<div class="col-12">
				<a class="btn btn-primary" [routerLink]="['/catalogue/categorysearch']" [queryParams]="{pageRef: 'menu', productType: 'product'}">
					<span>Add Product Category</span>
				</a>
        		<a class="btn btn-primary ml-1" [routerLink]="['/catalogue/categorysearch']" [queryParams]="{pageRef: 'menu', productType: 'transportation'}">
					<span>Add Logistics Service Category</span>
				</a>
				<table class="table table-striped table-bordered mb-0 mt-2">
					<tr><th>Name</th><th>Classification</th><th class="col-3">Actions</th></tr>
					<tr *ngIf="prefCats.length==0"><td colspan="3">No favorite categories</td></tr>
					<tr *ngFor="let prefCat of prefCats; let i = index">
						<td>{{prefCat.split("::")[2]}}</td>
            			<td>{{prefCat.split("::")[1]}}</td>
						<td>
							<button class="btn btn-danger btn-sm" (click)="removeCat(prefCat, i)">Remove Favorite</button>
							<call-status [callStatus]="categoriesCallStatus[i]"></call-status>
						</td>
					</tr>
				</table>
			</div>
		</div>

		<!-- Save Button -->
		<div class="row actions-row pr-0 space-before">
			<div class="col-10 call-status-col">
				<call-status [callStatus]="saveCallStatus"></call-status>
			</div>
			<div class="col-2">
				<button class="btn btn-primary action" [disabled]="!settingsForm.valid || !settingsForm.dirty || saveCallStatus.isLoading()" (click)="save(settingsForm)">
					Save
				</button>
			</div>
		</div>

	</form>
</ng-container>

<!-- Negotiation Settings, hidden to avoid reloading -->
<div [hidden]="selectedTab !== 'NEGOTIATION_SETTINGS'">
	<company-negotiation-settings>
	</company-negotiation-settings>
</div>

<!-- Modals -->
<ng-template #addCertModal let-d="dismiss">
	<form [formGroup]="addCertForm" novalidate>
		<div class="modal-header">
			<h4 class="modal-title">Add Certificate</h4>
			<button type="button" class="close" aria-label="Close" (click)="d('')">
				<span aria-hidden="true">&times;</span>
			</button>
		</div>
		<div class="modal-body">
				<div class="form-group row">
					<label class="col-2 col-form-label">File</label>
					<div class="col-10">
						<input type="file" class="form-control" [formControl]="addCertForm.controls['file']" (change)="setCertFile($event)" required>
					</div>
				</div>
				<div class="form-group row">
					<label class="col-2 col-form-label">Type</label>
					<div class="col-10">
						<select class="form-control" [formControl]="addCertForm.controls['type']" required>
							<option *ngFor="let ppapType of ppapTypes">{{ppapType}}</option>
						</select>
					</div>
				</div>
				<div class="form-group row">
					<label class="col-2 col-form-label">Name</label>
					<div class="col-10">
						<input type="text" class="form-control" [formControl]="addCertForm.controls['name']" required>
					</div>
				</div>
		</div>
		<div class="modal-footer">
			<call-status [callStatus]="saveCertCallStatus"></call-status>
			<button class="btn btn-primary save-cert-btn" [disabled]="!addCertForm.valid" (click)="saveCert(addCertForm, d);">
					<span>Save</span>
			</button>
		</div>
	</form>
</ng-template>

<ng-template #changeModal let-d="dismiss">
	<div class="modal-header">
		<h4 class="modal-title">Request Company Data Change</h4>
		<button type="button" class="close" aria-label="Close" (click)="d('')">
			<span aria-hidden="true">&times;</span>
		</button>
	</div>
	<div class="modal-body">
		Any change to your company data has to be validated and processed by a platform administrator.<br/><br/>
		When you press "Open mail template" a partially prefilled mail template will open in the mail client of your choice.<br/><br/>
		We will process change requests within one business day.
	</div>
	<div class="modal-footer">
		<a [href]="mailto" type="button" class="btn btn-primary" (click)="d('')">Open mail template</a>
	</div>
</ng-template>

<ng-template #tooltip let-d="dismiss">
	<div class="modal-header">
		<h4 class="modal-title">Tooltip</h4>
		<button type="button" class="close" aria-label="Close" (click)="d('')">
			<span aria-hidden="true">&times;</span>
		</button>
	</div>
	<div class="modal-body" [innerHTML]="tooltipHTML">
	</div>
</ng-template>
